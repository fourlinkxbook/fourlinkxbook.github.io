<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Modern Bookshelf - Real-time</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

  :root {
    --primary-color: #005f73;
    --secondary-color: #0a9396;
    --accent-color: #94d2bd;
    --background-color: #e9f1f7;
    --text-color: #001219;
    --btn-radius: 6px;
    --shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  header {
    background-color: var(--primary-color);
    color: white;
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
  }

  header h1 {
    font-weight: 600;
    margin: 0;
    font-size: 1.8rem;
    letter-spacing: 1px;
  }

  header button {
    background-color: var(--secondary-color);
    color: white;
    border: none;
    padding: 10px 18px;
    font-weight: 600;
    font-size: 1rem;
    border-radius: var(--btn-radius);
    cursor: pointer;
    box-shadow: var(--shadow);
    transition: background-color 0.3s ease;
  }
  header button:hover {
    background-color: var(--accent-color);
    color: var(--text-color);
  }

  main {
    flex: 1;
    padding: 24px;
    max-width: 900px;
    margin: 0 auto;
  }

  h2 {
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--primary-color);
  }

  #comingSoonList,
  #bookList {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(250px,1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .book-card {
    background: white;
    border-radius: var(--btn-radius);
    box-shadow: var(--shadow);
    padding: 16px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .book-title {
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 8px;
    color: var(--secondary-color);
    min-height: 48px;
  }

  .book-info {
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 12px;
  }

  .btn-download {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 10px 18px;
    cursor: pointer;
    border-radius: var(--btn-radius);
    font-weight: 600;
    transition: background-color 0.3s ease;
    box-shadow: inset 0 0 0 0 var(--accent-color);
  }
  .btn-download:hover {
    background-color: var(--accent-color);
    color: var(--text-color);
  }

  .coming-soon-label {
    color: var(--accent-color);
    font-weight: 700;
    font-size: 0.95rem;
    border: 2px dashed var(--accent-color);
    padding: 6px 10px;
    border-radius: var(--btn-radius);
    text-align: center;
    user-select: none;
  }

  /* Modal Styles */
  .modal {
    display: none; /* Hidden by default */
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s forwards;
  }

  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity:1;}
  }

  .modal-content {
    background-color: white;
    margin: 8% auto;
    padding: 24px;
    border-radius: var(--btn-radius);
    max-width: 400px;
    box-shadow: var(--shadow);
    position: relative;
    animation: slideIn 0.4s forwards;
  }

  @keyframes slideIn {
    from {transform: translateY(-20px); opacity: 0;}
    to {transform: translateY(0); opacity: 1;}
  }

  .close-btn {
    color: #aaa;
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
  }
  .close-btn:hover {
    color: var(--primary-color);
  }

  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: var(--primary-color);
  }

  input[type="text"],
  input[type="file"],
  input[type="password"],
  input[type="tel"] {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 16px;
    border-radius: var(--btn-radius);
    border: 2px solid #ccc;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  input[type="text"]:focus,
  input[type="file"]:focus,
  input[type="password"]:focus,
  input[type="tel"]:focus {
    outline: none;
    border-color: var(--secondary-color);
  }

  .modal button {
    width: 100%;
    padding: 12px;
    background-color: var(--secondary-color);
    border: none;
    color: white;
    font-weight: 700;
    font-size: 1rem;
    border-radius: var(--btn-radius);
    cursor: pointer;
    box-shadow: var(--shadow);
    transition: background-color 0.3s ease;
  }
  .modal button:hover {
    background-color: var(--accent-color);
    color: var(--text-color);
  }

  /* Payment info */
  #paymentInfo,
  #uploadPaymentBankDetails {
    margin-bottom: 16px;
    font-size: 1rem;
  }

  /* Upload Payment: Radio Buttons */
  .payment-method-option {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
  }
  .payment-method-option input[type="radio"] {
    margin-right: 10px;
  }

  #uploadPaymentBankDetails {
    border: 1px solid var(--accent-color);
    background-color: #e0f3f1;
    padding: 12px;
    border-radius: var(--btn-radius);
    font-weight: 600;
    color: var(--secondary-color);
    user-select: text;
  }

  #cardPaymentOptions {
    margin-bottom: 16px;
  }
  #cardPaymentOptions label {
    font-weight: 600;
    color: var(--primary-color);
  }

  /* Responsive */
  @media (max-width: 500px) {
    header h1 {
      font-size: 1.3rem;
    }
    header button {
      font-size: 0.9rem;
      padding: 8px 14px;
    }
  }
</style>
</head>
<body>
<header>
  <h1>Bookshelf</h1>
  <button id="uploadBtn">Upload Book</button>
</header>

<main>
  <section aria-label="Coming Soon Books">
    <h2>Coming Soon Books</h2>
    <div id="comingSoonList" aria-live="polite" aria-relevant="additions"></div>
  </section>

  <section aria-label="Available Books">
    <h2>Available Books</h2>
    <div id="bookList" aria-live="polite" aria-relevant="additions"></div>
  </section>
</main>

<!-- Upload Modal -->
<div id="uploadModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="uploadModalTitle" aria-hidden="true">
  <div class="modal-content">
    <span class="close-btn" id="uploadClose" tabindex="0" role="button" aria-label="Close Upload Modal">&times;</span>
    <h3 id="uploadModalTitle">Upload New Book</h3>
    <form id="uploadForm" novalidate>
      <label for="bookTitle">Book Title</label>
      <input type="text" id="bookTitle" name="bookTitle" placeholder="Enter book title" required minlength="2" maxlength="100" autocomplete="off"/>
      <label for="bookFile">Select Book File (PDF)</label>
      <input type="file" id="bookFile" name="bookFile" accept=".pdf" required />
      <button type="submit" disabled id="uploadSubmitBtn">Upload Book</button>
    </form>
  </div>
</div>

<!-- Upload Payment Modal -->
<div id="uploadPaymentModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="uploadPaymentModalTitle" aria-hidden="true">
  <div class="modal-content">
    <span class="close-btn" id="uploadPaymentClose" tabindex="0" role="button" aria-label="Close Payment Modal">&times;</span>
    <h3 id="uploadPaymentModalTitle">Payment for Upload</h3>
    <div id="uploadPaymentInfo">
      To upload the book, please complete the payment of <strong>1.00 USD</strong>.
    </div>
    <form id="uploadPaymentForm">
      <fieldset>
        <legend>Select Payment Method</legend>
        <div class="payment-method-option">
          <input type="radio" id="payCard" name="paymentMethod" value="card" required />
          <label for="payCard">Card Payment</label>
        </div>
        <div class="payment-method-option" style="margin-left: 20px; color: #555;">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" alt="Visa Logo" width="40" height="20" style="vertical-align:middle; margin-right:8px;">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/5a/Verve_Logo.png" alt="Verve Card Logo" width="40" height="20" style="vertical-align:middle; margin-right:8px;">
          <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Mastercard-logo.png" alt="MasterCard Logo" width="40" height="20" style="vertical-align:middle;">
        </div>
        <div class="payment-method-option">
          <input type="radio" id="payBank" name="paymentMethod" value="bank" />
          <label for="payBank">Bank Transfer</label>
        </div>
      </fieldset>
      <div id="uploadPaymentBankDetails" style="display:none;">
        <p><strong>Bank Account Number:</strong> 1234-5678-9012</p>
        <p>Please transfer the payment and then click "Confirm Payment".</p>
      </div>
      <div id="cardPaymentOptions" style="display:none;">
        <label for="cardNumber">Card Number</label>
        <input type="tel" id="cardNumber" name="cardNumber" placeholder="Enter your card number" pattern="\\d{13,19}" maxlength="19" required autocomplete="cc-number" />
        <label for="cardExpiry">Expiry Date (MM/YY)</label>
        <input type="text" id="cardExpiry" name="cardExpiry" placeholder="MM/YY" pattern="^(0[1-9]|1[0-2])\\/([0-9]{2})$" maxlength="5" required autocomplete="cc-exp" />
        <label for="cardCVV">CVV</label>
        <input type="password" id="cardCVV" name="cardCVV" placeholder="CVV" pattern="\\d{3,4}" maxlength="4" required autocomplete="cc-csc" />
      </div>
      <button type="submit" id="confirmUploadPaymentBtn" disabled>Confirm Payment</button>
    </form>
  </div>
</div>

<!-- Payment Modal (for download) -->
<div id="paymentModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="paymentModalTitle" aria-hidden="true">
  <div class="modal-content">
    <span class="close-btn" id="paymentClose" tabindex="0" role="button" aria-label="Close Payment Modal">&times;</span>
    <h3 id="paymentModalTitle">Complete Payment</h3>
    <div id="paymentInfo">
      Please pay 1.00 USD to download "<span id="paymentBookTitle"></span>".
    </div>
    <button id="payNowBtn">Pay with Opay</button>
  </div>
</div>

<script>
  (() => {
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadModal = document.getElementById('uploadModal');
    const uploadClose = document.getElementById('uploadClose');
    const uploadForm = document.getElementById('uploadForm');
    const bookTitleInput = document.getElementById('bookTitle');
    const bookFileInput = document.getElementById('bookFile');
    const uploadSubmitBtn = document.getElementById('uploadSubmitBtn');
    const bookList = document.getElementById('bookList');
    const comingSoonList = document.getElementById('comingSoonList');

    const uploadPaymentModal = document.getElementById('uploadPaymentModal');
    const uploadPaymentClose = document.getElementById('uploadPaymentClose');
    const uploadPaymentForm = document.getElementById('uploadPaymentForm');
    const payCardRadio = document.getElementById('payCard');
    const payBankRadio = document.getElementById('payBank');
    const uploadPaymentBankDetails = document.getElementById('uploadPaymentBankDetails');
    const cardPaymentOptions = document.getElementById('cardPaymentOptions');
    const confirmUploadPaymentBtn = document.getElementById('confirmUploadPaymentBtn');

    const paymentModal = document.getElementById('paymentModal');
    const paymentClose = document.getElementById('paymentClose');
    const paymentBookTitleElem = document.getElementById('paymentBookTitle');
    const payNowBtn = document.getElementById('payNowBtn');

    let books = [];
    let currentDownloadBook = null;
    let pendingUpload = null;

    // Hardcoded coming soon books
    const comingSoonBooks = [
      { title: "Mastering JavaScript ES2024" },
      { title: "Advanced CSS Techniques" },
      { title: "Modern Web Security Essentials" },
      { title: "Progressive Web Apps Guide" }
    ];

    // Utility function to save books to localStorage
    function saveBooks() {
      localStorage.setItem('bookshelf_books', JSON.stringify(books));
    }

    // Utility function to load books from localStorage
    function loadBooks() {
      const data = localStorage.getItem('bookshelf_books');
      if(data) {
        try {
          books = JSON.parse(data);
        } catch(e) {
          books = [];
          console.warn('Could not parse books from localStorage:', e);
        }
      } else {
        books = [];
      }
    }

    // React to changes in localStorage in other tabs (real-time sync)
    window.addEventListener('storage', event => {
      if(event.key === 'bookshelf_books') {
        loadBooks();
        renderBooks();
      }
    });

    // Function to create book cards in the Available Books UI
    function renderBooks() {
      bookList.innerHTML = '';
      if (books.length === 0) {
        bookList.innerHTML = '<p>No books available. Upload your first book!</p>';
        return;
      }
      books.forEach((book, index) => {
        const card = document.createElement('div');
        card.className = 'book-card';
        card.setAttribute('aria-label', `Book titled ${book.title}`);

        const title = document.createElement('div');
        title.className = 'book-title';
        title.textContent = book.title;

        const info = document.createElement('div');
        info.className = 'book-info';
        const uploadDate = new Date(book.uploadDate);
        info.textContent = `Uploaded: ${uploadDate.toLocaleDateString()} ${uploadDate.toLocaleTimeString()}`;

        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'btn-download';
        downloadBtn.textContent = 'Download';
        downloadBtn.setAttribute('aria-label', `Download book titled ${book.title}`);
        downloadBtn.addEventListener('click', () => {
          openPaymentModal(book, index);
        });

        card.appendChild(title);
        card.appendChild(info);
        card.appendChild(downloadBtn);

        bookList.appendChild(card);
      });
    }

    // Function to render Coming Soon books
    function renderComingSoonBooks() {
      comingSoonList.innerHTML = '';
      if (comingSoonBooks.length === 0) {
        comingSoonList.innerHTML = '<p>No upcoming books at the moment.</p>';
        return;
      }
      comingSoonBooks.forEach((book) => {
        const card = document.createElement('div');
        card.className = 'book-card';
        card.setAttribute('aria-label', `Coming soon book titled ${book.title}`);

        const title = document.createElement('div');
        title.className = 'book-title';
        title.textContent = book.title;

        const comingLabel = document.createElement('div');
        comingLabel.className = 'coming-soon-label';
        comingLabel.textContent = 'Coming Soon';

        card.appendChild(title);
        card.appendChild(comingLabel);

        comingSoonList.appendChild(card);
      });
    }

    // Open upload modal
    function openUploadModal() {
      uploadModal.style.display = 'block';
      uploadModal.setAttribute('aria-hidden', 'false');
      uploadSubmitBtn.disabled = true;
      uploadForm.reset();
      uploadSubmitBtn.setAttribute('aria-disabled','true');
      cardPaymentOptions.style.display = 'none';
      uploadPaymentBankDetails.style.display = 'none';
      bookTitleInput.focus();
    }

    // Close upload modal
    function closeUploadModal() {
      uploadModal.style.display = 'none';
      uploadModal.setAttribute('aria-hidden', 'true');
      uploadForm.reset();
      pendingUpload = null;
      uploadSubmitBtn.disabled = true;
      uploadSubmitBtn.setAttribute('aria-disabled','true');
    }

    // Open upload payment modal
    function openUploadPaymentModal() {
      uploadPaymentModal.style.display = 'block';
      uploadPaymentModal.setAttribute('aria-hidden', 'false');
      confirmUploadPaymentBtn.disabled = true;
      confirmUploadPaymentBtn.setAttribute('aria-disabled','true');
      payCardRadio.checked = false;
      payBankRadio.checked = false;
      uploadPaymentBankDetails.style.display = 'none';
      cardPaymentOptions.style.display = 'none';
      confirmUploadPaymentBtn.focus();
    }

    // Close upload payment modal
    function closeUploadPaymentModal() {
      uploadPaymentModal.style.display = 'none';
      uploadPaymentModal.setAttribute('aria-hidden', 'true');
      confirmUploadPaymentBtn.disabled = true;
      confirmUploadPaymentBtn.setAttribute('aria-disabled','true');
      payCardRadio.checked = false;
      payBankRadio.checked = false;
      uploadPaymentBankDetails.style.display = 'none';
      cardPaymentOptions.style.display = 'none';
    }

    // Open payment modal for a specific book download
    function openPaymentModal(book, index) {
      currentDownloadBook = { ...book, index };
      paymentBookTitleElem.textContent = book.title;
      paymentModal.style.display = 'block';
      paymentModal.setAttribute('aria-hidden', 'false');
      payNowBtn.focus();
    }

    // Close payment modal (download)
    function closePaymentModal() {
      paymentModal.style.display = 'none';
      paymentModal.setAttribute('aria-hidden', 'true');
      currentDownloadBook = null;
    }

    // Enable or disable submit button on upload form based on inputs validity
    function validateUploadForm() {
      const title = bookTitleInput.value.trim();
      const file = bookFileInput.files[0];
      if (title.length >= 2 && title.length <= 100 && file && file.type === 'application/pdf') {
        uploadSubmitBtn.disabled = false;
        uploadSubmitBtn.removeAttribute('aria-disabled');
      } else {
        uploadSubmitBtn.disabled = true;
        uploadSubmitBtn.setAttribute('aria-disabled','true');
      }
    }

    // Book Data Validation and escrow on form submit
    uploadForm.addEventListener('submit', e => {
      e.preventDefault();

      const titleInputVal = bookTitleInput.value.trim();
      const fileInputVal = bookFileInput.files[0];

      // Book Data Validation
      if (!titleInputVal) {
        alert('Please enter a book title.');
        return;
      }
      if (titleInputVal.length < 2 || titleInputVal.length > 100) {
        alert('Book title must be between 2 and 100 characters.');
        return;
      }
      if (!fileInputVal) {
        alert('Please select a valid PDF file.');
        return;
      }
      if (fileInputVal.type !== 'application/pdf') {
        alert('Only PDF files are supported.');
        return;
      }
      if (fileInputVal.size > 20 * 1024 * 1024) {
        alert('File size must be less than 20MB.');
        return;
      }

      // Store data in escrow
      pendingUpload = { title: titleInputVal, file: fileInputVal };

      closeUploadModal();
      openUploadPaymentModal();
    });

    // Monitor upload form inputs to enable submit button
    bookTitleInput.addEventListener('input', validateUploadForm);
    bookFileInput.addEventListener('change', validateUploadForm);

    // Payment method selection handling
    uploadPaymentForm.addEventListener('change', e => {
      if(e.target.name === 'paymentMethod') {
        if(e.target.value === 'bank') {
          uploadPaymentBankDetails.style.display = 'block';
          cardPaymentOptions.style.display = 'none';
          setCardInputsRequired(false);
        } else {
          uploadPaymentBankDetails.style.display = 'none';
          cardPaymentOptions.style.display = 'block';
          setCardInputsRequired(true);
        }
        confirmUploadPaymentBtn.disabled = false;
        confirmUploadPaymentBtn.removeAttribute('aria-disabled');
      }
    });

    function setCardInputsRequired(required) {
      const cardInputs = cardPaymentOptions.querySelectorAll('input');
      cardInputs.forEach(input => {
        if(required) {
          input.setAttribute('required', 'required');
        } else {
          input.removeAttribute('required');
        }
      });
    }

    // Confirm payment and release escrow
    uploadPaymentForm.addEventListener('submit', e => {
      e.preventDefault();
      const selectedMethod = uploadPaymentForm.paymentMethod.value;
      if (!selectedMethod) {
        alert('Please select a payment method.');
        return;
      }
      if (!pendingUpload) {
        alert('No book data found to upload.');
        closeUploadPaymentModal();
        return;
      }

      if(selectedMethod === 'card') {
        const cardNumber = uploadPaymentForm.cardNumber.value.trim();
        const cardExpiry = uploadPaymentForm.cardExpiry.value.trim();
        const cardCVV = uploadPaymentForm.cardCVV.value.trim();

        if(!/^\d{13,19}$/.test(cardNumber)) {
          alert('Please enter a valid card number (13 to 19 digits).');
          return;
        }
        if(!/^(0[1-9]|1[0-2])\\/([0-9]{2})$/.test(cardExpiry)) {
          alert('Please enter a valid expiry date in MM/YY format.');
          return;
        }
        if(!/^\d{3,4}$/.test(cardCVV)) {
          alert('Please enter a valid CVV (3 or 4 digits).');
          return;
        }
      }

      confirmUploadPaymentBtn.disabled = true;
      confirmUploadPaymentBtn.textContent = 'Processing Payment...';

      // Simulate payment processing and escrow release
      setTimeout(() => {
        if(selectedMethod === 'card') {
          alert('Card payment successful! Uploading book now.');
        } else {
          alert('Bank transfer payment successful! Uploading book now.');
        }

        // Release escrow to main storage
        const reader = new FileReader();
        reader.onload = (event) => {
          books.push({
            title: pendingUpload.title,
            uploadDate: new Date().toISOString(),
            fileData: event.target.result
          });
          saveBooks();
          renderBooks();

          pendingUpload = null;
          closeUploadPaymentModal();
        };
        reader.readAsDataURL(pendingUpload.file);
      }, 2000);
    });

    // Download payment simulation
    payNowBtn.addEventListener('click', () => {
      if (!currentDownloadBook) return;

      payNowBtn.disabled = true;
      payNowBtn.textContent = 'Processing...';

      setTimeout(() => {
        payNowBtn.disabled = false;
        payNowBtn.textContent = 'Pay with Opay';
        alert(`Payment successful! Downloading "${currentDownloadBook.title}" now.`);
        downloadBook(currentDownloadBook);
        closePaymentModal();
      }, 1500);
    });

    function downloadBook(book) {
      const link = document.createElement('a');
      link.href = book.fileData;
      link.download = book.title.replace(/\s+/g, '_') + '.pdf';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    uploadClose.addEventListener('click', closeUploadModal);
    uploadPaymentClose.addEventListener('click', () => {
      closeUploadPaymentModal();
      pendingUpload = null;
    });
    paymentClose.addEventListener('click', closePaymentModal);

    window.addEventListener('click', e => {
      if (e.target === uploadModal) closeUploadModal();
      if (e.target === uploadPaymentModal) {
        closeUploadPaymentModal();
        pendingUpload = null;
      }
      if (e.target === paymentModal) closePaymentModal();
    });

    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        if (uploadModal.style.display === 'block') closeUploadModal();
        if (uploadPaymentModal.style.display === 'block') {
          closeUploadPaymentModal();
          pendingUpload = null;
        }
        if (paymentModal.style.display === 'block') closePaymentModal();
      }
    });

    // Initial load
    loadBooks();
    renderBooks();
    renderComingSoonBooks();

    uploadBtn.addEventListener('click', openUploadModal);
  })();
</script>
</body>
</html>

